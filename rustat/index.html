<html><meta http-equiv="Content-type: text/html; charset=UTF-8">
    <head>
        <title>
            RuStat - Российская статистика
        </title>
        <link rel="stylesheet" href="st.css">
        <link rel="stylesheet" href="/libs/jstree/themes/default/style.min.css" />
        <link rel="stylesheet" href="css/jquery-ui-1.10.3.custom.css"/>


        <script src="/libs/js/jquery.min.js"></script>
        <script src="/libs/jstree/jstree.min.js"></script>
        <script src="/libs/js/highcharts.js"></script>
        <script src="/libs/js/exporting.js"></script>
       	<script src="/libs/js/jquery-ui-1.10.3.custom.min.js"></script>
        <script src="/libs/js/FileSaver.min.js"></script>
        <script src="/libs/zimap/zimap.js"></script>
        <script src="/libs/zimap/zivis.js"></script>
        <script src="db.js"></script>
        <script src="link.js"></script>
        <style>
        </style>
    </head>
    <body>
        <div id="buttons">
            <input type="button" value="Выбор данных" onclick="show('dbsel', this.value)"/>
            <input type="button" value="Настройки" onclick="show('sets', this.value)"/>
            <input type="button" value="Экспорт" onclick="show('export', this.value)"/>
            <input type="button" value="Справка" onclick="show('help', this.value)"/>
        </div><br/>

        <div id="main">
            <div id="vis">
                <!--img src="map.png"/--></div>
            <div id="header"><div id="headerText"></div>
                <input type="button" style="position:inherit;top:0px;right:0px;" value="Закрыть" onclick="closee()"/></div>

            <div id="dbsel" class="subwindow">
                <table id="seltab">
                    <tr>
                        <td id="parcol">Параметры<!--input type="button" value="x" class="xbutton"--></td>
                        <td id="regcol">Регионы<!--input type="button" value="x" class="xbutton"--></td>
                        <!-- td id="yearcol">Годы<div class="xbutton"><input type="button" value="v" ><input type="button" value="x"></div></td -->
                    </tr>
                    <tr id="seltrees">
                        <td>
                            <div id="partree" class="seltree">
                            </div>
                        </td>
                        <td>
                            <div id="regtree" class="seltree">
                            </div>
                        </td>
                        <!--td>
                            <div id="yeartree" class="seltree">
                            </div>
                        </td-->
                    </tr>
                </table>
            </div>

            <div id="sets" class="subwindow">
                Ширина <input id="viswidth" type="number" value="800">
                <!--Высота <input id="visheight" type="number" value="600"-->
                <hr>
                <div id="setsradio">
                    <input id="radTable" type="radio" name="vistype" value="Table"/>
                    <label for="radTable">Таблица</label>
                    <input id="radChart" type="radio" name="vistype" value="Chart"/>
                    <label for="radChart">Диаграмма</label>
                    <input id="radMap" type="radio" name="vistype" value="Map" checked/>
                    <label for="radMap">Картограмма</label>
                    <hr>
                    <div id="radTableDiv">
                        Настройки таблицы отсутствуют. Пока что...
                    </div>
                    <div id="radChartDiv">
                        Тип диаграммы: 
                        <select id="charttype">
                            <option value="line" selected>график</option>
                            <option value="pie">круговая</option>
                            <!--option value="column">гистограмма</option>
                            <option value="bar">горизонтальная гистограмма</option-->
                        </select>
                    </div>
                    <div id="radMapDiv">
                        <!--Карта:<select size="1" name="maps" id="maps">
                            <option value="russia">Россия - субъекты федерации</option>
                            <option value="russia2">Россия - федеральные округа</option>
                            <option value="world3">Мир</option>
                        </select><br/-->
                        Раскрашивание:
                        <input id="radColtypeBlock" type="radio" name="coltype" value="Block">
                        <label for="radColtypeBlock">Блоками</label>
                        <input id="radColtypeGradient" type="radio" name="coltype" value="Gradient" checked>
                        <label for="radColtypeGradient">Непрерывное</label>
                    </div>
                </div>
            </div>

            <div id="export" class="subwindow">
                Ссылка: <input id="vislink" type="text" size="50" onclick="this.select();"><hr>
                Код<!-- (для вставки в блог или на сайт)-->: <input id="viscode" type="text" size="50" onclick="this.select();">
            </div>

            <div id="help" class="subwindow">
                <div id="helpradio">
                    <input id="radHelp" type="radio" name="helpRad" value="Help"/>
                    <label for="radHelp">Помощь</label>
                    <input id="radAbout" type="radio" name="helpRad" value="About" checked/>
                    <label for="radAbout">О программе</label>
                    <hr>
                    <div id="radHelpDiv">
                    </div>
                    <div id="radAboutDiv">
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script>
                function createParNodesFromFile(root, leaf, path) {
                    $.ajax({
                        url: path,
                        dataType: 'text',
                        async: false,
                        success: function(data) {
                            var mas = data.replace(/\r/g, '').split("\n");
                            for (var i in mas) {
                                if (i == 0 || mas[i] == "")
                                    continue;
                                var str = mas[i].split(";");
                                root.jstree(true).create_node(leaf, {id: path.substring(8) + "-" + str[0], text: str[0]});
                            }
                        }
                    });
                }
                function createParNodes(root, leaf, path) {
                    $.ajax({
                        url: path + 'list.csv',
                        dataType: 'text',
                        async: false,
                        success: function(data) {
                            //alert(data);
                            var mas = data.replace(/\r/g, '').split("\n");
                            for (var i in mas) {
                                if (mas[i] == "")
                                    continue;
                                var str = mas[i].split(";");
                                var leafId;
                                var id = path.substring(8) + str[0];
                                if (str[2] != "11")
                                    leafId = root.jstree(true).create_node(leaf, {id: id, text: str[1], state: {selected: id == selector.ps}});
                                if (str[2] == "11") {
                                    leafId = root.jstree(true).create_node(leaf, {id: id, text: str[1], state: {selected: id == selector.ps}, a_attr: {
                                            class: "no_checkbox"
                                        }});
                                    createParNodes(root, root.jstree(true).get_node(leafId), path + str[0] + "/");
                                } else if (str[2] == "22") {
                                    createParNodesFromFile(root, root.jstree(true).get_node(leafId), path + str[0] + ".csv");
                                }
                            }
                        }
                    });
                }
                function createRegNodes(root, leaf, list, id) {
                    for (var i in  list) {
                        var cur = list[i];
                        cur.id = cur.code + id;
                        cur.state = {
                            selected: $.inArray(cur.code, selector.sregs) >= 0
                        };
                        var leafId = root.jstree(true).create_node(leaf, cur);
                        if (cur.leaves != undefined) {
                            createRegNodes(root, root.jstree(true).get_node(leafId), cur.leaves, ":" + cur.id);
                        }
                    }
                }

                function createRegTree(rt) {
                    var $root = $("#regtree").jstree({
                        core: {
                            check_callback: true
                        },
                        plugins: ["checkbox"]
                    });
                    createRegNodes($root, $root, rt, "");
                }

                var selector;
                $(function() {
                    $("#setsradio").ziradio();
                    $("#helpradio").ziradio();
                    $.ajax({
                        url: "help.html",
                        dataType: "text",
                        success: function(data) {
                            $("#radHelpDiv").html(data);
                        }
                    });
                    $.ajax({
                        url: "about.html",
                        dataType: "text",
                        success: function(data) {
                            $("#radAboutDiv").html(data);
                        }
                    });
                    /*$.ajax({
                        url: '/libs/zimap/maps/maps.txt',
                        dataType: 'html',
                        success: function(data) {
                            drawMaps(data);
                        }
                    });*/
                    var lnk = {};
                    selector = new Selector();

                    if (location.search != "") {
                        lnk = linkDecode(location.search.substring(1));
                        //alert(lnk.pars[0]);
                        $('#rad' + lnk.vistype).attr('checked', true).trigger('change');
                        selector.ps = lnk.pars[0];
                        selector.sregs = lnk.regs;
                        if (lnk.vistype == "Chart") {
                            charttype.value = lnk.chartType;
                        }else if (lnk.vistype == "Map") {
                            $('#radColtype' + lnk.colType).attr('checked', true).trigger('change');
                        }
                    } else {
                        selector.ps = "NAS/CHI";
                        selector.sregs = ["RU-SF"];
                    }
                    var $root = $("#partree").jstree({
                        core: {
                            check_callback: true,
                            multiple: false
                        },
                        checkbox: {
                            three_state: false
                        },
                        plugins: ["checkbox"]
                    });
                    createParNodes($root, $root, "db/pars/");


                    //alert(selector.getRegs()[1][1]);
                    createRegTree(selector.getTree());
                    apply();
                });


                function show(dn, ht) {
                    headerText.innerHTML = ht;
                    for (var i in main.childNodes) {
                        var d = main.childNodes[i];
                        if (d.tagName == 'DIV') {
                            if (d.id == dn || d.id == 'header' || d.id == 'vis') {
                                d.style.visibility = "visible";
                            } else {
                                d.style.visibility = "hidden";
                            }
                        }
                    }
                    $("#vis").css({"opacity": "0.5"});
                }


                function closee() {
                    for (var i in main.childNodes) {
                        var d = main.childNodes[i];
                        if (d.tagName == 'DIV' && d.id != 'vis') {
                            d.style.visibility = "hidden";
                        }
                    }
                    apply();

                }

                function apply() {
                    selector.clearSelect();
                    $.each($("#partree")
                            .jstree("get_checked", true)
                            , function(key, value) {
                        if (value.children.length == 0)
                            selector.spars.push({id: value.id, text: value.text});
                    });
                    $.each($("#regtree")
                            .jstree("get_checked", true)
                            , function(key, value) {
                        if (value.children.length == 0)
                            selector.sregs.push(value.id.split(":")[0]);
                    });
                    var vistype = $('input[name="vistype"]:checked').val();
                    if (vistype == "Map")
                        selector.iso = true;
                    else
                        selector.iso = false;
                    $("#vis").css({width: viswidth.value});
                    selector.select(function(result, title) {
                        $("#vis").html("");
                        $("<div></div>").appendTo("#vis").zivis(obj = {
                            data: {
                                table: result, //[[1, 2, 3], [0, 1, 2]]//,
                                //rowstnum : 1
                                title: title
                            },
                            settings: {
                                vistype: vistype,
                                //chartType:charttype.value,
                                type: $('input[name="coltype"]:checked').val(),
                                chartType: charttype.value,
                                showLegend: true
                            }
                        });
                        $("#vis").css({"opacity": "1"});
                    });

                    var lnk = {
                        pars: [],
                        regs: selector.sregs,
                        //title: title,
                        vistype: vistype
                    };
                    if (lnk.vistype == "Chart") {
                        lnk.chartType = charttype.value;
                    }else if (lnk.vistype == "Map") {
                        lnk.colType = $('input[name="coltype"]:checked').val();
                    }
                    $.each(selector.spars, function(i, v) {
                        lnk.pars.push(v.id)
                    });
                    var str = linkEncode(lnk);
                    vislink.value = "http://" + location.host + location.pathname + "?" + str;
                    //location.search = "?"+str;
                }
    </script>
    <br/><hr/>
    <footer>
        Copyright (c) 2013, 2014 <a href="mailto:zaycev.ivan@gmail.com">Зайцев И.Д.</a> (zaycev.ivan@gmail.com, <a href="/main/">home page</a>)<br/>
        Источник данных - <a href="http://www.gks.ru">Сайт Федеральной службы государственной статистики РФ</a><br/>
        Источник карты - <a href="http://commons.wikimedia.org/wiki/File%3AMap_of_Russian_districts%2C_2008-03-01.svg"/>Викимедия</a><br/>
</footer>
<script>
    if (location.href.split('/')[2] != '127.0.0.1') {
        (function(i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function() {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-41768406-1', 'navizv.github.io');
        ga('send', 'pageview');
    }
</script>
</html>