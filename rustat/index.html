<html>
    <head>
        <title>
            Test for RuStat
        </title>
        <link rel="stylesheet" href="st.css">
        <link rel="stylesheet" href="/libs/jstree/themes/default/style.min.css" />
        <link rel="stylesheet" href="css/jquery-ui-1.10.3.custom.css"/>
        

        <script src="/libs/js/jquery.min.js"></script>
        <script src="/libs/jstree/jstree.min.js"></script>
        <script src="/libs/js/highcharts.js"></script>
        <script src="/libs/js/exporting.js"></script>
       	<script src="/libs/js/jquery-ui-1.10.3.custom.min.js"></script>
        <script src="/libs/js/FileSaver.min.js"></script>
        <script src="/libs/zimap/zimap.js"></script>
        <script src="/libs/zimap/zivis.js"></script>
        <script src="db.js"></script>
        <style>
        </style>
    </head>
    <body>
        <div id="buttons">
            <input type="button" value="Выбор данных" onclick="show('dbsel', this.value)"/>
            <input type="button" value="Настройки" onclick="show('sets', this.value)"/>
            <input type="button" value="Экспорт" onclick="show('export', this.value)"/>
            <input type="button" value="Помощь" onclick="show('help', this.value)"/>
        </div><br/>

        <div id="main">
            <div id="vis">
                <img src="map.png"/></div>
            <div id="header"><div id="headerText"></div>
                <input type="button" style="position:inherit;top:0px;right:0px;" value="Закрыть" onclick="closee()"/></div>

            <div id="dbsel" class="subwindow">
                <table id="seltab">
                    <tr>
                        <td id="parcol">Параметры<!--input type="button" value="x" class="xbutton"--></td>
                        <td id="regcol">Регионы<!--input type="button" value="x" class="xbutton"--></td>
                        <!-- td id="yearcol">Годы<div class="xbutton"><input type="button" value="v" ><input type="button" value="x"></div></td -->
                    </tr>
                    <tr id="seltrees">
                        <td>
                            <div id="partree" class="seltree">
                            </div>
                        </td>
                        <td>
                            <div id="regtree" class="seltree">
                            </div>
                        </td>
                        <!--td>
                            <div id="yeartree" class="seltree">
                            </div>
                        </td-->
                    </tr>
                </table>
            </div>

            <div id="sets" class="subwindow">
                Ширина <input id="viswidth" type="number" value="800">
                <!--Высота <input id="visheight" type="number" value="600"-->
                <hr>
                <input id="radtab" type="radio" name="vistype" value="Table" checked/>
                <label for="radtab">Таблица</label>
                <input id="radchart" type="radio" name="vistype" value="Chart" checked/>
                <label for="radchart">Диаграмма</label>
                <input id="radmap" type="radio" name="vistype" value="Map" checked/>
                <label for="radmap">Картограмма</label>
                <hr>
                Здесь будут настройки визуализации, специфичные для выбранной формы.
            </div>

            <div id="export" class="subwindow">
                export
                <img src="seldb.png"/>
            </div>

            <div id="help" class="subwindow">
                help
                <img src="seldb.png"/>
            </div>
        </div>
    </body>

    <script>
                function createParNodesFromFile(root, leaf, path) {
                    $.ajax({
                        url: path,
                        dataType: 'text',
                        success: function(data) {
                            var mas = data.split("\r\n");
                            for (var i in mas) {
                                if (i == 0 || mas[i] == "")
                                    continue;
                                var str = mas[i].split(";");
                                root.jstree(true).create_node(leaf, {id: path + ":" + str[0], text: str[0]});
                            }
                        }
                    });
                }
                function createParNodes(root, leaf, path) {
                    $.ajax({
                        url: path + 'list.csv',
                        dataType: 'text',
                        success: function(data) {
                            //alert(data);
                            //data.replace(/\r\n/g,'\n');
                            var mas = data.split("\r\n");
                            for (var i in mas) {
                                if (mas[i] == "")
                                    continue;
                                var str = mas[i].split(";");
                                var leafId;
                                if (str[2] != "11")
                                    leafId = root.jstree(true).create_node(leaf, {id: path + str[0] + ".csv", text: str[1]});
                                if (str[2] == "11") {
                                    leafId = root.jstree(true).create_node(leaf, {id: path + str[0] + ".csv", text: str[1], a_attr: {
                                            class: "no_checkbox"
                                        }});
                                    createParNodes(root, root.jstree(true).get_node(leafId), path + str[0] + "/");
                                } else if (str[2] == "22") {
                                    createParNodesFromFile(root, root.jstree(true).get_node(leafId), path + str[0] + ".csv");
                                }
                            }
                        }
                    });
                }
                function createRegNodes(root, leaf, list, id) {
                    for (var i in  list) {
                        var cur = list[i];
                        cur.id = cur.code + id;
                        var leafId = root.jstree(true).create_node(leaf, cur);
                        if (cur.leaves != undefined) {
                            createRegNodes(root, root.jstree(true).get_node(leafId), cur.leaves, ":" + cur.id);
                        }
                    }
                }

                function createRegTree(rt) {
                    var $root = $("#regtree").jstree({
                        core: {
                            check_callback: true
                        },
                        plugins: ["checkbox"]
                    });
                    createRegNodes($root, $root, rt, "");
                }
                var selector;
                $(function() {
                    var $root = $("#partree").jstree({
                        core: {
                            check_callback: true,
                            multiple: false
                        },
                        checkbox: {
                            three_state: false
                        },
                        plugins: ["checkbox"]
                    });
                    createParNodes($root, $root, "db/pars/");

                    selector = new Selector();
                    //alert(selector.getRegs()[1][1]);
                    createRegTree(selector.getTree());
                });


                function show(dn, ht) {
                    headerText.innerHTML = ht;
                    for (var i in main.childNodes) {
                        var d = main.childNodes[i];
                        if (d.tagName == 'DIV') {
                            if (d.id == dn || d.id == 'header' || d.id == 'vis') {
                                d.style.visibility = "visible";
                            } else {
                                d.style.visibility = "hidden";
                            }
                        }
                    }
                    $("#vis").css({"opacity": "0.5"});
                }


                function closee() {
                    for (var i in main.childNodes) {
                        var d = main.childNodes[i];
                        if (d.tagName == 'DIV' && d.id != 'vis') {
                            d.style.visibility = "hidden";
                        }
                    }
                    apply();

                }

                function apply() {
                    selector.clearSelect();
                    $.each($("#partree")
                            .jstree("get_checked", true)
                            , function(key, value) {
                        if (value.children.length == 0)
                            selector.spars.push({id: value.id, text: value.text});
                    });
                    $.each($("#regtree")
                            .jstree("get_checked", true)
                            , function(key, value) {
                        if (value.children.length == 0)
                            selector.sregs.push(value.id.split(":")[0]);
                    });
                    var vistype = $('input[name="vistype"]:checked').val();
                    if (vistype == "Map")
                        selector.iso = true;
                    else
                        selector.iso = false;
                    $("#vis").css({width: viswidth.value});
                    selector.select(function(result, title) {
                        $("#vis").html("");
                        $("<div></div>").appendTo("#vis").zivis(obj = {
                            data: {
                                table: result, //[[1, 2, 3], [0, 1, 2]]//,
                                //rowstnum : 1
                                title: title
                            },
                            settings: {
                                vistype: vistype,
                                //chartType:charttype.value,
                                type: "Gradient",
                                showLegend: true
                            }
                        });
                        $("#vis").css({"opacity": "1"});
                    });

                }
    </script>
    <br/><hr/>
    <footer>
        Copyright (c) 2013, 2014 <a href="mailto:zaycev.ivan@gmail.com">Зайцев И.Д.</a> (zaycev.ivan@gmail.com, <a href="/main/">home page</a>)<br/>
        Источник данных - <a href="http://www.gks.ru">Сайт Федеральной службы государственной статистики РФ</a><br/>
        Источник карты - <a href="http://commons.wikimedia.org/wiki/File%3AMap_of_Russian_districts%2C_2008-03-01.svg"/>Викимедия</a><br/>
</footer>
<script>
    if (location.href.split('/')[2] != '127.0.0.1') {
        (function(i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function() {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-41768406-1', 'navizv.github.io');
        ga('send', 'pageview');
    }
</script>
</html>